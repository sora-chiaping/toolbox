<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>海運暫估工具（LCL+FCL 一體版｜精簡介面）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 780px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #555;
      margin: 0 0 10px 0;
      font-size: 24px;
    }
    p {
      color: #666;
      font-size: 14px;
      margin: 0 0 20px 0;
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 16px;
      background-color: #fff;
      color: #333;
    }
    input:focus, select:focus {
      outline: 2px solid #007BFF;
      border-color: #007BFF;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .amount {
      display: none;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }
    .box {
      background-color: #fafafa;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }
    .title {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }
    .amt {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }
    .btn {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 15px;
      width: 100%;
    }
    .btn:hover {
      background-color: #0056b3;
    }
    details {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 15px;
    }
    details summary {
      cursor: pointer;
      color: #007BFF;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .muted {
      color: #666;
      font-size: 13px;
      line-height: 1.6;
    }
    .small {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
    .badge {
      display: inline-block;
      background-color: #e8f4fd;
      border: 1px solid #b3d9ff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: #0066cc;
      margin-left: 6px;
    }
    .ok {
      display: inline-block;
      background-color: #e6ffe6;
      border: 1px solid #ccffcc;
      color: #006600;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 8px;
    }
    .success-message {
      color: #006600;
      background-color: #e6ffe6;
      border: 1px solid #ccffcc;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
    }
    .error-message {
      color: #ff0000;
      background-color: #ffe6e6;
      border: 1px solid #ffcccc;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
      <h1>海運暫估工具（LCL+FCL 一體版｜精簡）</h1>
      <p>輸入最少欄位就能估：LCL 只需 <b>CBM</b>；FCL 只選 <b>櫃型</b>。港口可從清單選或自行新增。</p>

      <div class="grid">
        <div class="form-group">
          <label for="type">運送型態</label>
          <select id="type">
            <option value="LCL" selected>LCL（散貨）</option>
            <option value="20GP">FCL：20'GP</option>
            <option value="40GP">FCL：40'GP</option>
            <option value="40HQ">FCL：40'HQ</option>
          </select>
        </div>
        <div class="form-group">
          <label for="port">起運港口</label>
          <select id="port"></select>
          <div class="small">沒有的港口 → 下方「新增港口」加入即可</div>
        </div>
      </div>

      <div id="lclInputs" class="grid" style="margin-top:20px">
        <div class="form-group">
          <label for="cbm">CBM（僅 LCL 需要）</label>
          <input id="cbm" type="number" step="0.01" placeholder="例如 7.802 / 11.49">
        </div>
        <div class="form-group">
          <label for="buffer">保守緩衝（LCL）</label>
          <select id="buffer">
            <option value="0">無</option>
            <option value="3000" selected>+3,000</option>
            <option value="5000">+5,000</option>
            <option value="10000">+10,000（高風險）</option>
          </select>
        </div>
      </div>

      <div id="amount" class="amount">
        <div class="box">
          <div class="title" id="stdTitle">標準估</div>
          <div class="amt" id="std">—</div>
        </div>
        <div class="box">
          <div class="title" id="consTitle">保守估</div>
          <div class="amt" id="cons">—</div>
        </div>
      </div>

      <button class="btn" id="copy">複製估算</button>

      <details>
        <summary>如何使用</summary>
        <div class="muted" style="margin-top:8px;line-height:1.7">
          <b>LCL：</b>輸入 CBM → 選港口 → （可選）保守緩衝。系統會顯示「標準估」與「保守估」。<br>
          <b>FCL：</b>選櫃型與港口即可，系統會顯示「基準區間（不含雜支）」與「含雜支區間」。<br>
          <span class="badge">提示</span> 若無法判斷是否會出現雜支，建議使用保守估或選擇較大的緩衝。
        </div>
      </details>

      <details>
        <summary>LCL 的三種保守緩衝怎麼選？</summary>
        <div class="muted" style="margin-top:8px;line-height:1.8">
          <b>+3,000：</b>常規情境（深圳/廣州/香港，非旺季），當作安全邊際。<br>
          <b>+5,000：</b>旺季、卡車距離較長、或你希望預提再保守一點。<br>
          <b>+10,000：</b>高風險港口（如天津/寧波），或可能有進倉/打托/港雜/抽驗等情況。<br>
          <span class="ok">目標</span> 多數票落在標準估 ±3,000；不確定時改用保守緩衝避免低估。
        </div>
      </details>

      <details>
        <summary>新增港口</summary>
        <div class="muted" style="margin-top:8px">
          若你的港口不在清單，可在這裡加入並設定風險附加（估算時會自動加總）。資料會保存在你的瀏覽器。
          <div class="row" style="margin-top:15px">
            <div class="form-group">
              <label for="newPortCode">港口代碼/名稱</label>
              <input id="newPortCode" placeholder="例如 SZX / 深圳">
            </div>
            <div class="form-group">
              <label for="newRisk">風險附加（TWD）</label>
              <input id="newRisk" type="number" step="100" placeholder="例如 0 / 4000 / 10000">
            </div>
            <div class="form-group" style="display:flex;align-items:flex-end">
              <button class="btn" id="addPort">加入港口</button>
            </div>
          </div>
          <div class="small" id="saveMsg"></div>
        </div>
      </details>

      <details>
        <summary>運費資料管理</summary>
        <div class="muted" style="margin-top:8px">
          上傳最新的海運運費資料來提高估算準確性。支援 Excel (.xlsx) 和 CSV 格式。
          <div style="margin-top:15px">
            <div class="form-group">
              <label for="freightFileInput">上傳運費資料檔案</label>
              <input type="file" id="freightFileInput" accept=".xlsx,.xls,.csv" style="width: 100%; padding: 8px; margin-bottom: 10px;">
              <button onclick="downloadFreightTemplate()" style="background-color: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px;">下載範本檔案</button>
            </div>
            
            <div class="form-group">
              <label>範本格式說明：</label>
              <div class="small" style="margin-top:5px; line-height: 1.6;">
                <strong>LCL 資料格式：</strong> 港口代碼, CBM範圍, 基準價格, 備註<br>
                <strong>FCL 資料格式：</strong> 港口代碼, 櫃型, 最低價格, 最高價格, 備註<br>
                範例：<br>
                SZX, 1-3, 15000, 標準LCL<br>
                SZX, 20GP, 25000, 35000, 標準FCL
              </div>
            </div>
            
            <div class="form-group">
              <button class="btn" id="uploadFreightData" style="background-color: #17a2b8; margin-top: 10px;">上傳並更新運費資料</button>
            </div>
            
            <div id="freightUploadMsg" class="small" style="margin-top:10px;"></div>
            
            <div style="margin-top:15px; padding:10px; background-color: #f8f9fa; border-radius: 4px;">
              <strong>目前載入的運費資料：</strong>
              <div id="currentFreightData" class="small" style="margin-top:5px;"></div>
            </div>
          </div>
        </div>
      </details>
  </div>

  <script>
    const nf = new Intl.NumberFormat('zh-Hant-TW',{style:'currency',currency:'TWD',maximumFractionDigits:0});
    const $ = (id)=>document.getElementById(id);

    // --- Port list with localStorage persistence ---
    const DEFAULT_PORTS = [
      {id:"SZX", name:"深圳 / SZX", risk:0},
      {id:"GZ", name:"廣州 / GZ", risk:0},
      {id:"HK", name:"香港 / HK", risk:0},
      {id:"XINGANG", name:"天津 / XINGANG", risk:10000},
      {id:"NGB", name:"寧波 / NGB", risk:10000},
      {id:"OTHER", name:"其他 / OTHER", risk:4000}
    ];

    // --- Freight data management ---
    let customFreightData = {
      lcl: [], // {port, cbmRange, basePrice, note}
      fcl: []  // {port, containerType, minPrice, maxPrice, note}
    };

    function loadFreightData() {
      try {
        const saved = JSON.parse(localStorage.getItem("customFreightData") || "{}");
        customFreightData = {
          lcl: saved.lcl || [],
          fcl: saved.fcl || []
        };
        updateFreightDataDisplay();
      } catch(e) {
        console.error("載入運費資料失敗:", e);
      }
    }

    function saveFreightData() {
      try {
        localStorage.setItem("customFreightData", JSON.stringify(customFreightData));
        updateFreightDataDisplay();
      } catch(e) {
        console.error("儲存運費資料失敗:", e);
      }
    }

    function updateFreightDataDisplay() {
      const display = document.getElementById('currentFreightData');
      if (!display) return;
      
      let html = '';
      if (customFreightData.lcl.length > 0) {
        html += '<strong>LCL 資料：</strong><br>';
        customFreightData.lcl.forEach(item => {
          html += `• ${item.port} - ${item.cbmRange} CBM: ${nf.format(item.basePrice)}<br>`;
        });
      }
      if (customFreightData.fcl.length > 0) {
        html += '<strong>FCL 資料：</strong><br>';
        customFreightData.fcl.forEach(item => {
          html += `• ${item.port} - ${item.containerType}: ${nf.format(item.minPrice)} ~ ${nf.format(item.maxPrice)}<br>`;
        });
      }
      if (html === '') {
        html = '目前使用預設運費資料';
      }
      display.innerHTML = html;
    }

    function loadPorts(){
      try{
        const saved = JSON.parse(localStorage.getItem("portList")||"[]");
        return [...DEFAULT_PORTS, ...saved];
      }catch(e){ return DEFAULT_PORTS.slice(); }
    }
    function saveCustomPort(p){
      const saved = JSON.parse(localStorage.getItem("portList")||"[]");
      saved.push(p);
      localStorage.setItem("portList", JSON.stringify(saved));
    }
    function renderPortOptions(){
      const ports = loadPorts();
      const sel = $("port");
      sel.innerHTML = "";
      ports.forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        opt.dataset.risk = p.risk;
        sel.appendChild(opt);
      });
      sel.selectedIndex = 0;
    }
    function getPortRisk(){
      const sel = $("port");
      const opt = sel.options[sel.selectedIndex];
      return parseFloat(opt.dataset.risk||"0");
    }

    // --- File upload and template functions ---
    function downloadFreightTemplate() {
      const templateData = [
        ['港口代碼', 'CBM範圍/櫃型', '基準價格/最低價格', '最高價格', '備註'],
        ['SZX', '1-3', '15000', '', '標準LCL'],
        ['SZX', '3-6', '12000', '', '標準LCL'],
        ['SZX', '20GP', '25000', '35000', '標準FCL'],
        ['SZX', '40GP', '32000', '42000', '標準FCL'],
        ['GZ', '1-3', '14000', '', '廣州LCL'],
        ['GZ', '20GP', '24000', '34000', '廣州FCL']
      ];
      
      const ws = XLSX.utils.aoa_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '運費資料範本');
      
      XLSX.writeFile(wb, '海運運費資料範本.xlsx');
      showFreightMessage('範本檔案下載完成', 'success');
    }

    function handleFreightFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          parseFreightData(jsonData);
        } catch (error) {
          showFreightMessage('檔案解析失敗：' + error.message, 'error');
        }
      };
      
      if (file.name.endsWith('.csv')) {
        reader.readAsText(file);
      } else {
        reader.readAsBinaryString(file);
      }
    }

    function parseFreightData(data) {
      const newLclData = [];
      const newFclData = [];
      let errorCount = 0;

      // 跳過標題行
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row || row.length < 3) continue;

        const port = row[0]?.toString().trim();
        const typeOrRange = row[1]?.toString().trim();
        const baseOrMinPrice = parseFloat(row[2]) || 0;
        const maxPrice = parseFloat(row[3]) || 0;
        const note = row[4]?.toString().trim() || '';

        if (!port || !typeOrRange || baseOrMinPrice <= 0) {
          errorCount++;
          continue;
        }

        // 判斷是 LCL 還是 FCL 資料
        if (typeOrRange.includes('GP') || typeOrRange.includes('HQ') || typeOrRange.includes('FCL')) {
          // FCL 資料
          newFclData.push({
            port: port,
            containerType: typeOrRange,
            minPrice: baseOrMinPrice,
            maxPrice: maxPrice || baseOrMinPrice,
            note: note
          });
        } else if (typeOrRange.includes('-') || typeOrRange.includes('CBM')) {
          // LCL 資料
          newLclData.push({
            port: port,
            cbmRange: typeOrRange,
            basePrice: baseOrMinPrice,
            note: note
          });
        } else {
          errorCount++;
        }
      }

      if (errorCount > 0) {
        showFreightMessage(`成功解析 ${newLclData.length + newFclData.length} 筆資料，${errorCount} 筆格式錯誤已跳過`, 'warning');
      } else {
        showFreightMessage(`成功解析 ${newLclData.length + newFclData.length} 筆資料`, 'success');
      }

      // 更新資料
      customFreightData.lcl = newLclData;
      customFreightData.fcl = newFclData;
      saveFreightData();
    }

    function showFreightMessage(message, type) {
      const msgDiv = document.getElementById('freightUploadMsg');
      if (!msgDiv) return;
      
      const className = type === 'error' ? 'error-message' : 
                      type === 'warning' ? 'success-message' : 'success-message';
      msgDiv.innerHTML = `<div class="${className}" style="margin: 0; padding: 8px;">${message}</div>`;
      
      setTimeout(() => {
        msgDiv.innerHTML = '';
      }, 5000);
    }

    // --- Enhanced estimation models with custom data ---
    function lclBase(cbm){
      // 先檢查是否有自定義 LCL 資料
      const port = getCurrentPort();
      const customLcl = customFreightData.lcl.find(item => item.port === port);
      
      if (customLcl) {
        // 解析 CBM 範圍並找到對應的價格
        const range = customLcl.cbmRange;
        if (range.includes('-')) {
          const [min, max] = range.split('-').map(x => parseFloat(x.trim()));
          if (cbm >= min && cbm <= max) {
            return customLcl.basePrice;
          }
        }
      }
      
      // 使用預設計算方式
      if(cbm < 1) return 9000;
      if(cbm < 1.5) return 12000 + 5000*cbm;
      if(cbm < 3) return 6000 + 3000*cbm;
      if(cbm < 6) return 2500 + 2200*cbm + 4200;
      if(cbm < 9) return 2200*cbm + 4200;
      if(cbm < 12) return 500 + 3300*cbm + 4800;
      return 3600*cbm + 4800;
    }
    
    function fclBase(type){
      // 先檢查是否有自定義 FCL 資料
      const port = getCurrentPort();
      const customFcl = customFreightData.fcl.find(item => 
        item.port === port && item.containerType === type
      );
      
      if (customFcl) {
        return [customFcl.minPrice, customFcl.maxPrice];
      }
      
      // 使用預設計算方式
      if(type==="20GP") return [25000,35000];
      if(type==="40GP") return [32000,42000];
      if(type==="40HQ") return [36000,45000];
      return [0,0];
    }

    function getCurrentPort() {
      const sel = document.getElementById('port');
      const opt = sel.options[sel.selectedIndex];
      return opt.value;
    }

    function calc(){
      const type = $("type").value;
      const risk = getPortRisk();

      if(type === "LCL"){
        $("lclInputs").style.display = "grid";
        $("stdTitle").textContent="標準估（LCL）";
        $("consTitle").textContent="保守估（LCL）";

        const cbm = parseFloat($("cbm").value);
        if(isNaN(cbm) || cbm <= 0){ $("amount").style.display="none"; return; }
        let std = Math.round(lclBase(cbm) + risk);
        const buf = parseFloat($("buffer").value)||0;
        let cons = std + buf;
        $("std").textContent = nf.format(std);
        $("cons").textContent = nf.format(cons);
        $("amount").style.display = "grid";
      }else{
        $("lclInputs").style.display = "none";
        $("stdTitle").textContent="基準區間（FCL 不含雜支）";
        $("consTitle").textContent="含雜支區間（+5K～10K）";

        let [lo,hi] = fclBase(type);
        lo += risk; hi += risk;
        $("std").textContent = `${nf.format(lo)} ～ ${nf.format(hi)}`;
        $("cons").textContent = `${nf.format(lo+5000)} ～ ${nf.format(hi+10000)}`;
        $("amount").style.display = "grid";
      }
    }

    // Events
    ["type","port","cbm","buffer"].forEach(id=>{
      const el = $(id); if(el) el.addEventListener('input', calc);
    });
    document.getElementById('copy').addEventListener('click', ()=>{
      const type = $("type").value;
      const sel = $("port");
      const portName = sel.options[sel.selectedIndex].textContent;
      let txt = `型態：${type}\n港口：${portName}\n`;
      if(type==="LCL"){
        txt += `CBM：${$("cbm").value||'-'}\n標準估：${$("std").textContent}\n保守估：${$("cons").textContent}`;
      }else{
        txt += `基準估：${$("std").textContent}\n含雜支估：${$("cons").textContent}`;
      }
      navigator.clipboard.writeText(txt);
    });

    // Add custom port
    $("addPort").addEventListener('click', ()=>{
      const id = $("newPortCode").value.trim();
      const risk = parseFloat($("newRisk").value||"0");
      if(!id){ $("saveMsg").textContent="請輸入港口代碼或名稱"; return; }
      saveCustomPort({id, name:id, risk:isNaN(risk)?0:risk});
      renderPortOptions();
      $("saveMsg").textContent = `已加入：${id}（風險附加 ${isNaN(risk)?0:risk}）`;
      $("newPortCode").value=""; $("newRisk").value="";
    });

    // init
    renderPortOptions();
    loadFreightData();
    calc();
    
    // 添加檔案上傳事件監聽器
    document.getElementById('freightFileInput').addEventListener('change', handleFreightFileUpload);
    document.getElementById('uploadFreightData').addEventListener('click', function() {
      const fileInput = document.getElementById('freightFileInput');
      if (fileInput.files.length > 0) {
        handleFreightFileUpload({ target: fileInput });
      } else {
        showFreightMessage('請先選擇檔案', 'error');
      }
    });
  </script>
</body>
</html>
